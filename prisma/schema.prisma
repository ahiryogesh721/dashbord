generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum LeadStage {
  new
  contacted
  visit_scheduled
  visit_done
  closed
  lost
}

enum InterestLabel {
  hot
  warm
  cold
}

enum SiteVisitStatus {
  scheduled
  completed
  cancelled
  no_show
}

enum FollowUpStatus {
  pending
  completed
  skipped
  cancelled
}

model Lead {
  id            String         @id @default(uuid()) @db.Uuid
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  callDate      DateTime?      @map("call_date")
  customerName  String?        @map("customer_name")
  phone         String?        @unique
  goal          String?
  preference    String?
  visitDateTime DateTime?      @map("visit_datetime")
  summary       String?
  recordingUrl  String?        @map("recording_url")
  duration      Int?
  score         Int?
  interestLabel InterestLabel? @map("interest_label")
  confidence    Float?
  aiReason      String?        @map("ai_reason")
  stage         LeadStage      @default(new)
  source        String         @default("voice_ai")
  rawPayload    Json?          @map("raw_payload")

  siteVisits SiteVisit[]
  followUps  FollowUp[]

  @@index([stage])
  @@index([score])
  @@index([visitDateTime])
  @@map("leads")
}

model SiteVisit {
  id           String          @id @default(uuid()) @db.Uuid
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")
  leadId       String          @map("lead_id") @db.Uuid
  scheduledFor DateTime?       @map("scheduled_for")
  completedAt  DateTime?       @map("completed_at")
  status       SiteVisitStatus @default(scheduled)
  notes        String?

  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([status])
  @@map("site_visits")
}

model FollowUp {
  id          String         @id @default(uuid()) @db.Uuid
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")
  leadId      String         @map("lead_id") @db.Uuid
  dueAt       DateTime       @map("due_at")
  channel     String         @default("whatsapp")
  message     String?
  status      FollowUpStatus @default(pending)
  completedAt DateTime?      @map("completed_at")

  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId, status, dueAt])
  @@map("follow_ups")
}
